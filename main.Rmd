---
title: "sta302"
author: "Pierre Catoire"
date: "15/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(papeR)
library(mice)
library(visdat)
library(VIM)
library(epiDisplay)

set.seed(1)
```

## Enoncé

Sujet 5: Association entre score de santé cardio-vasculaire optimale et évolution de la symptomatologie dépressive chez les personnes âgées.

Un score de Santé Cardio-Vasculaire optimale a été très récemment associé à un risque réduit de démence et un déclin cognitif moindre chez les personnes âgées [1]. L’objectif de ce projet est d’évaluer si ce score de santé Cardio-Vasculaire optimale est aussi associé à l’évolution de la symptomatologie dépressive chez les personnes âgées. Dans un premier temps, il s’agira d’évaluer l’impact de la santé cardio-vasculaire optimale
sur la trajectoire de la symptomatologie dépressive telle que mesurée par la CES-D (la CES-D sera considérée comme une variable quantitative). Dans un deuxième temps, on pourra prendre en compte dans l’analyse l’association entre trajectoire de CES-D et la survenue de démence.

Données

Le travail sera réalisé à partir des données de l’étude des 3 Cités (3C), une cohorte populationnelle multicentrique (Bordeaux, Dijon, Montpellier) dont l’objectif était d’étudier l’impact des facteurs vasculaires sur le risque de démence dans la population âgée de 65 ans et plus. Est mis à la disposition du projet un extrait de la cohorte 3C sur les trois villes. La CES-D a été mesurée à l’inclusion puis aux suivis 1,2,4,5 et 6 ayant
eu lieu environ 2 ans, 4 ans, 7 ans, 10 ans et 12 ans après l’inclusion. L’analyse pourra être ajustée sur des facteurs de confusion potentiels.

## Chargement des données

```{r}
df = read.delim("base_3C_CVideal.txt")
names(df) = toupper(names(df))

#Vérification de l'absence de données manquantes
nrow(df[is.na.data.frame(df),])

#Vérification du type de variables
sapply(df,class)

#Correction du type de variables
df$DC6 = as.factor(df$DC6)
df$SEXE = as.factor(df$SEXE)
df$DEM0_6 = as.factor(df$DEM0_6)
df$CENTRE = as.factor(df$CENTRE)
df$ETUDE_CLAS0 = as.factor(df$ETUDE_CLAS0)
df$ANTIDEP0 = as.factor(df$ANTIDEP0)

#Vérification de la correction des types de variables
sapply(df,class)

labels(df) = c("Indicateur de décès",
               "Âge au décès ou âge aux dernières nouvelles",
               "Sexe",
               "Score de CES-D à T0",
               "Âge à l'inclusion",
               "Indicateur de démence incidente",
               "Âge de démence incidente ou temps de censure",
               "Ville de la cohorte (1:Bordeaux, 2:Dijon, 3:Montpellier)",
               "Niveau d'études en classes (1: sans études ou primaire, 2: secondaire court, 3: secondaire long, 4: enseignement supérieur",
               "Traitement antidépresseur à l'inclusion (1: oui, 0: non",
               "Âge à la visite de suivi 1",
               "Âge à la visite de suivi 2",
               "Âge à la visite de suivi 4",
               "Âge à la visite de suivi 5",
               "Âge à la visite de suivi 6",
               "Score de santé cardiovasculaire total",
               "Score de santé cardiovasculaire optimale",
               "Score CES-D à la visite de suivi 1",
               "Score CES-D à la visite de suivi 2",
               "Score CES-D à la visite de suivi 4",
               "Score CES-D à la visite de suivi 5",
               "Score CES-D à la visite de suivi 6",
               "Identifiant du sujet")
```

```{r}
sapply(c("factor","numeric"),
       papeR::summarise,
       data = df)
```

```{r}
#Création d'une variable IO (Indicateur d'observation), qui prend pour valeur :
# - 1 si aucune donnée manquante
# - 0 si au moins une donnée manquante
df$IO = ifelse(complete.cases(df),1,0)

vis_dat(df)
md.pattern(df)[length(md.pattern(df)[,1]),]/length(df$ID)

tabpct(df$DEM0_6,df$IO)
```

On constate qu'il y a des données manquantes pour les variables CESDT0 à CESDT6 et AGE1 à AGE6. Ces données manquantes peuvent correspondre à des dates de dernière nouvelle ou à des absences intermittentes. On teste cette question sur AGE1 et AGE2.

```{r}
df %>% filter(is.na(AGE1) & !is.na(AGE2))
```

Il y a donc des patients qui ont été absents à la visite 1 et non à la visite 2.

On recherche s'il y a des visites où l'âge a été recueilli et non le score de dépression :

```{r}
df %>% filter(is.na(AGE0) & !is.na(CESDT0))
df %>% filter(is.na(AGE6) & !is.na(CESDT6))
```

Il n'y a pas de tel cas.

### Imputation multiple

```{r}
pred_mat = matrix(rep(1), nrow = ncol(df), ncol = ncol(df))
names = colnames(df)
rownames(pred_mat) = names
colnames(pred_mat) = names
diag(pred_mat) = 0
pred_mat[c("ID", "IO"),] = 0

#A revoir sur quelles variables doivent être ""
imput_method = method = c("",
                          "",
                          "",
                          "norm",
                          "",
                          "",
                          "",
                          "",
                          "",
                          "",
                          "norm",
                          "",
                          "",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "norm",
                          "",
                          "")
df_imput = mice(data = df,
                m = 10,
                method = imput_method,
                predictorMatrix = pred_mat,
                seed = 1000)
df_imput$imp$CESDT5
```


A faire :
- description des données
- description des variables manquantes
- imputation multiple

Quel codage du sexe ?!

```{r}
xyplot(CESDT6~AGEFIN6-AGE0,
       group=ID,data=df,
       type=c("l")
       )
```

### Verification de la normalité de la variable d'intérêt

```{r}
par(mfrow=c(2,3))
plot(density(df$CESDT0,na.rm=T))
plot(density(df$CESDT1,na.rm=T))
plot(density(df$CESDT2,na.rm=T))
plot(density(df$CESDT4,na.rm=T))
plot(density(df$CESDT5,na.rm=T))
plot(density(df$CESDT6,na.rm=T))
```

On propose une transformation en log :

```{r}
par(mfrow=c(2,3))
plot(density(log(df$CESDT0),na.rm=T))
plot(density(log(df$CESDT1),na.rm=T))
plot(density(log(df$CESDT2),na.rm=T))
plot(density(log(df$CESDT4),na.rm=T))
plot(density(log(df$CESDT5),na.rm=T))
plot(density(log(df$CESDT6),na.rm=T))
```

```{r}
par(mfrow=c(2,3))
plot(density(sqrt(df$CESDT0),na.rm=T))
plot(density(sqrt(df$CESDT1),na.rm=T))
plot(density(sqrt(df$CESDT2),na.rm=T))
plot(density(sqrt(df$CESDT4),na.rm=T))
plot(density(sqrt(df$CESDT5),na.rm=T))
plot(density(sqrt(df$CESDT6),na.rm=T))
```


### Présentation du modèle

On propose le modèle suivant :

$$
Y_{ij} = (\beta_{0}+\alpha_{0i}+\beta_{2}^{T}X)+(\beta_{1}+\alpha_{1i}+\beta_{3}^{T}X)t_{ij}+\epsilon
$$

avec :
$$
\alpha = \begin{pmatrix}\alpha_{0i} \\ \alpha_{1i}\end{pmatrix} \sim\mathcal{N}\big( 0,\mathcal{B}\big)
$$

et

$$
\epsilon \sim \mathcal{N}(0,\sigma_{e}^{2})
$$



```{r}
# Modification de la table

# Sauvegarde de la table
dfSave = df
df = dfSave
#df = dfSave

#Création d'une variable NVISITE qui prend une valeur 0, 1, 2, 4, 5, 6 selon le numéro de la visite
df$NVISITE = ifelse(is.na(df$AGE0),NA,0)
df$AGEVISITE = df$AGE0
df$CESDTVISITE = df$CESDT0

for(id in sort(dfSave$ID)){
  newrow1 = c()
  newrow2 = c()
  newrow4 = c()
  newrow5 = c()
  newrow6 = c()
  
  if(!is.na(df[df$ID==id,]$AGE1)){
    newrow1 = c(df[df$ID == id,])
    newrow1$NVISITE = 1
    newrow1$AGEVISITE = newrow1$AGE1
    newrow1$CESDTVISITE = newrow1$CESDT1
  }
  
  if(!is.na(df[df$ID==id,]$AGE2)){
    newrow2 = c(df[df$ID == id,])
    newrow2$NVISITE = 2
    newrow2$AGEVISITE = newrow2$AGE2
    newrow2$CESDTVISITE = newrow2$CESDT2
  }
  
  if(!is.na(df[df$ID==id,]$AGE4)){
    newrow4 = c(df[df$ID == id,])
    newrow4$NVISITE = 4
    newrow4$AGEVISITE = newrow4$AGE4
    newrow4$CESDTVISITE = newrow4$CESDT4
  }
  
  if(!is.na(df[df$ID==id,]$AGE5)){
    newrow5 = c(df[df$ID == id,])
    newrow5$NVISITE = 5
    newrow5$AGEVISITE = newrow5$AGE5
    newrow5$CESDTVISITE = newrow5$CESDT5
  }
  
  if(!is.na(df[df$ID==id,]$AGE6)){
    newrow6 = c(df[df$ID == id,])
    newrow6$NVISITE = 6
    newrow6$AGEVISITE = newrow6$AGE6
    newrow6$CESDTVISITE = newrow6$CESDT6
  }
  
  if(length(newrow1) != 0){df[nrow(df)+1,] = newrow1}
  if(length(newrow2) != 0){df[nrow(df)+1,] = newrow2}
  if(length(newrow4) != 0){df[nrow(df)+1,] = newrow4}
  if(length(newrow5) != 0){df[nrow(df)+1,] = newrow5}
  if(length(newrow6) != 0){df[nrow(df)+1,] = newrow6}
}

df = df[order(df$ID),

```


Je reajoute

